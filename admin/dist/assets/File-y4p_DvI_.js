import{_ as k,J as U,au as L,a0 as C,a1 as x,c as p,a as o,b as f,w as v,V as D,r as V,T as c,F as R,o as a,d as m,e as b,f as n,l as h,g as j,t as r,h as M,i as O,j as g,k as A}from"../index.js";import{a as y,F as B}from"./FileListItems-BgArmzs5.js";import{a as I,F as N}from"./FileDialog-D2KRu_32.js";import"./HistoryDialog-BhGSg-LU.js";const S={components:{FileListItems:B,FileUrlDialog:N,FileDetail:y,FileDialog:I},inject:["openView"],props:{modelValue:{type:[Object,null],default:()=>null},config:{type:Object,default:()=>{}},assets:{type:Object,default:()=>{}},readonly:{type:Boolean,default:!1}},emits:["update:modelValue","error","addFile","removeFile"],data(){return{file:{},index:Math.floor(Math.random()*1e5),selected:null,vfiles:!1,vurls:!1}},setup(){const e=L(),t=C();return{app:x(),auth:t,messages:e}},unmounted(){var e,t;(t=(e=this.file)==null?void 0:e.path)!=null&&t.startsWith("blob:")&&URL.revokeObjectURL(this.file.path)},methods:{add(e){if(!this.auth.can("file:add")){this.messages.add(this.$gettext("Permission denied"),"error");return}if(!(e!=null&&e.length))return;const t=URL.createObjectURL(e[0]);return this.file={path:t,uploading:!0},this.$apollo.mutate({mutation:U`mutation($file: Upload!) {
            addFile(file: $file) {
              id
              mime
              name
              path
              previews
              updated_at
              editor
            }
          }`,variables:{file:e[0]},context:{hasUpload:!0}}).then(s=>{var l;if(s.errors)throw s.errors;const d=((l=s.data)==null?void 0:l.addFile)||{};return d.previews=JSON.parse(d.previews)||{},delete d.__typename,this.handle(d,t)}).catch(s=>{this.messages.add("Error uploading file","error"),this.$log("File::addFile(): Error uploading file",ev,s)}).finally(()=>{this.selected=null})},handle(e,t){if(!(e!=null&&e.id)){this.$log("File::handle(): Invalid item without ID",e);return}return this.file={...e},this.$emit("addFile",e.id),this.$emit("update:modelValue",{id:e.id,type:"file"}),this.validate(),t!=null&&t.startsWith("blob:")&&URL.revokeObjectURL(t),e},open(e){this.openView(y,{item:e})},remove(){this.file.path.startsWith("blob:")&&URL.revokeObjectURL(this.file.path),this.file.id&&this.$emit("removeFile",this.file.id),this.$emit("update:modelValue",null),this.file={},this.validate()},select(e){if(!Array.isArray(e)||!e.length){this.$log("File::select(): Items must be a non-empty array",e);return}const t=e.shift();this.file={...t},this.$emit("addFile",t.id),this.$emit("update:modelValue",{id:t.id,type:"file"}),this.validate()},url(e){return e.startsWith("http")||e.startsWith("blob:")?e:this.app.urlfile.replace(/\/+$/g,"")+"/"+e},async validate(){const e=!!(!this.config.required||this.file.path);return this.$emit("error",!e),await e}},watch:{assets:{handler(e){!this.file.path&&this.modelValue&&e[this.modelValue.id]&&(this.file=e[this.modelValue.id]),this.validate()}},modelValue:{immediate:!0,handler(e){!this.file.path&&e&&this.assets[e.id]&&(this.file=this.assets[e.id]),this.validate()}}}},W={class:"files"},q={key:1,class:"file"};function z(e,t,s,d,l,u){const F=V("FileDialog"),w=V("FileUrlDialog");return a(),p(R,null,[o(D,null,{default:v(()=>[o(b,{cols:"12",md:"6"},{default:v(()=>[n("div",W,[l.file.path?(a(),p("div",{key:0,class:"file",onClick:t[1]||(t[1]=i=>u.open(l.file))},[l.file.uploading?(a(),f(j,{key:0,color:"primary",height:"5",indeterminate:"",rounded:""})):m("",!0),t[10]||(t[10]=n("svg",{draggable:"false",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",class:"bi bi-file-earmark-binary",viewBox:"0 0 16 16"},[n("path",{d:"M7.05 11.885c0 1.415-.548 2.206-1.524 2.206C4.548 14.09 4 13.3 4 11.885c0-1.412.548-2.203 1.526-2.203.976 0 1.524.79 1.524 2.203m-1.524-1.612c-.542 0-.832.563-.832 1.612q0 .133.006.252l1.559-1.143c-.126-.474-.375-.72-.733-.72zm-.732 2.508c.126.472.372.718.732.718.54 0 .83-.563.83-1.614q0-.129-.006-.25zm6.061.624V14h-3v-.595h1.181V10.5h-.05l-1.136.747v-.688l1.19-.786h.69v3.633z"}),n("path",{d:"M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"})],-1)),h(" "+r(l.file.name)+" ",1),!s.readonly&&l.file.path?(a(),p("button",{key:1,onClick:t[0]||(t[0]=M(i=>u.remove(),["stop"])),class:"btn-overlay",title:"Remove file",type:"button"},[o(O,{icon:"mdi-trash-can",role:"img"})])):m("",!0)])):s.readonly?m("",!0):(a(),p("div",q,[d.auth.can("file:view")?(a(),f(g,{key:0,onClick:t[2]||(t[2]=i=>l.vfiles=!0),icon:"mdi-button-cursor",variant:"flat"})):m("",!0),o(g,{onClick:t[3]||(t[3]=i=>l.vurls=!0),icon:"mdi-link-variant-plus",variant:"flat"}),o(g,{icon:"mdi-upload",variant:"flat"},{default:v(()=>[o(A,{modelValue:l.selected,"onUpdate:modelValue":[t[4]||(t[4]=i=>l.selected=i),t[5]||(t[5]=i=>u.add(i))],accept:s.config.accept||"*","hide-input":!0,"prepend-icon":"mdi-upload"},null,8,["modelValue","accept"])]),_:1})]))])]),_:1}),l.file.path?(a(),f(b,{key:0,cols:"12",md:"6"},{default:v(()=>[h(r(e.$gettext("Name"))+": "+r(l.file.name),1),t[11]||(t[11]=n("br",null,null,-1)),h(" "+r(e.$gettext("Mime"))+": "+r(l.file.mime),1),t[12]||(t[12]=n("br",null,null,-1)),h(" "+r(e.$gettext("Editor"))+": "+r(l.file.editor),1),t[13]||(t[13]=n("br",null,null,-1)),h(" "+r(e.$gettext("Updated"))+": "+r(new Date(l.file.updated_at).toLocaleString()),1)]),_:1,__:[11,12,13]})):m("",!0)]),_:1}),(a(),f(c,{to:"body"},[o(F,{modelValue:l.vfiles,"onUpdate:modelValue":t[6]||(t[6]=i=>l.vfiles=i),onAdd:t[7]||(t[7]=i=>{u.handle(i),l.vfiles=!1})},null,8,["modelValue"])])),(a(),f(c,{to:"body"},[o(w,{modelValue:l.vurls,"onUpdate:modelValue":t[8]||(t[8]=i=>l.vurls=i),onAdd:t[9]||(t[9]=i=>{u.select(i),l.vurls=!1})},null,8,["modelValue"])]))],64)}const P=k(S,[["render",z]]);export{P as default};
