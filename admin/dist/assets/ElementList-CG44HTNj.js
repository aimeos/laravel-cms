import{U as W,A as G,N as K}from"./Navigation-CGIIaB9V.js";import{_ as D,J as V,a0 as k,b as $,w as a,ax as U,o as f,a as l,ay as T,aa as X,d as P,ab as C,ac as L,l as g,t as d,ad as N,az as O,f as o,c,F as w,a2 as q,aA as Y,b7 as Q,aB as Z,a1 as x,r as v,V as H,e as I,E as _,ak as ee,au as te,aE as R,aF as M,aG as z,T as le,aH as J,j as b,aI as E,H as ae,X as se,aJ as ie,G as ne,i as A,aK as re,h as de,a6 as oe,a7 as j,aC as ue,aD as B}from"../index.js";import{H as me,A as he}from"./HistoryDialog-BhGSg-LU.js";import{F as fe,E as ge}from"./ElementListItems-nAx2RULT.js";const pe={props:{item:{type:Object,required:!0}},emits:[],data:()=>({panel:[0,1,2],versions:{},element:{}}),setup(){return{auth:k()}},watch:{item:{immediate:!0,handler(e){!e.id||!this.auth.can("element:view")||this.$apollo.query({query:V`query ($id: ID!) {
              element(id: $id) {
                id
                bypages {
                  id
                  path
                  name
                }
                byversions {
                  id
                  versionable_id
                  versionable_type
                  published
                  publish_at
                }
              }
            }`,variables:{id:e.id}}).then(t=>{var s,n,m;if(t.errors)throw t.errors;this.element=((s=t.data)==null?void 0:s.element)||{},this.versions=(((m=(n=t.data)==null?void 0:n.element)==null?void 0:m.byversions)||[]).map(i=>({id:i.versionable_id,type:i.versionable_type.split("\\").at(-1),published:i.published?this.$gettext("yes"):i.publish_at?new Date(i.publish_at).toLocaleDateString():this.$gettext("no")})).filter(i=>this.auth.can(i.type.toLowerCase()+":view"))}).catch(t=>{this.$log("ElementDetailRef::watch(item): Error fetching element",e,t)})}}}};function be(e,t,s,n,m,i){return f(),$(U,null,{default:a(()=>[l(T,null,{default:a(()=>[l(X,{modelValue:e.panel,"onUpdate:modelValue":t[0]||(t[0]=p=>e.panel=p),elevation:"0",multiple:""},{default:a(()=>{var p,u;return[(p=e.element.bypages)!=null&&p.length&&n.auth.can("page:view")?(f(),$(C,{key:0},{default:a(()=>[l(L,null,{default:a(()=>[g(d(e.$gettext("Shared elements")),1)]),_:1}),l(N,null,{default:a(()=>[l(O,{density:"comfortable",hover:""},{default:a(()=>[o("thead",null,[o("tr",null,[o("th",null,d(e.$gettext("ID")),1),o("th",null,d(e.$gettext("URL")),1),o("th",null,d(e.$gettext("Name")),1)])]),o("tbody",null,[(f(!0),c(w,null,q(e.element.bypages,h=>(f(),c("tr",{key:h.id},[o("td",null,d(h.id),1),o("td",null,d(h.path),1),o("td",null,d(h.name),1)]))),128))])]),_:1})]),_:1})]),_:1})):P("",!0),(u=e.versions)!=null&&u.length?(f(),$(C,{key:1},{default:a(()=>[l(L,null,{default:a(()=>t[1]||(t[1]=[g("Versions")])),_:1,__:[1]}),l(N,null,{default:a(()=>[l(O,{density:"comfortable",hover:""},{default:a(()=>[o("thead",null,[o("tr",null,[o("th",null,d(e.$gettext("ID")),1),o("th",null,d(e.$gettext("Type")),1),o("th",null,d(e.$gettext("Published")),1)])]),o("tbody",null,[(f(!0),c(w,null,q(e.versions,h=>(f(),c("tr",{key:h.id},[o("td",null,d(h.id),1),o("td",null,d(h.type),1),o("td",null,d(h.published),1)]))),128))])]),_:1})]),_:1})]),_:1})):P("",!0)]}),_:1},8,["modelValue"])]),_:1})]),_:1})}const ve=D(pe,[["render",be],["__scopeId","data-v-295f0259"]]),ye={components:{Fields:fe},props:{item:{type:Object,required:!0},assets:{type:Object,default:()=>{}}},emits:["update:item","error"],inject:["locales"],setup(){const e=Y(),t=Q(),s=Z(),n=k();return{app:x(),auth:n,languages:e,schemas:t,side:s}},computed:{readonly(){return!this.auth.can("element:save")}},methods:{fields(e){var t,s;return e?(t=this.schemas.content[e])!=null&&t.fields?(s=this.schemas.content[e])==null?void 0:s.fields:(console.warn(`No definition of fields for "${e}" schemas`),[]):[]},update(e,t){this.item[e]=t,this.$emit("update:item",this.item)}}};function ce(e,t,s,n,m,i){const p=v("Fields");return f(),$(U,null,{default:a(()=>[l(T,null,{default:a(()=>[l(H,null,{default:a(()=>[l(I,{cols:"12",md:"6"},{default:a(()=>[l(_,{ref:"name",readonly:i.readonly,modelValue:s.item.name,"onUpdate:modelValue":t[0]||(t[0]=u=>i.update("name",u)),variant:"underlined",label:e.$gettext("Name"),counter:"255",maxlength:"255"},null,8,["readonly","modelValue","label"])]),_:1}),l(I,{cols:"12",md:"6"},{default:a(()=>[l(ee,{ref:"lang",items:i.locales(!0),readonly:i.readonly,modelValue:s.item.lang,"onUpdate:modelValue":t[1]||(t[1]=u=>i.update("lang",u)),variant:"underlined",label:e.$gettext("Language")},null,8,["items","readonly","modelValue","label"])]),_:1})]),_:1}),l(H,null,{default:a(()=>[l(I,{cols:"12"},{default:a(()=>[l(p,{ref:"field",data:s.item.data,"onUpdate:data":t[2]||(t[2]=u=>s.item.data=u),files:s.item.files,"onUpdate:files":t[3]||(t[3]=u=>s.item.files=u),fields:i.fields(s.item.type),readonly:i.readonly,assets:s.assets,onError:t[4]||(t[4]=u=>e.$emit("error",u)),onChange:t[5]||(t[5]=u=>e.$emit("update:item",s.item))},null,8,["data","files","fields","readonly","assets"])]),_:1})]),_:1})]),_:1})]),_:1})}const Ve=D(ye,[["render",ce]]),$e={components:{AsideMeta:he,HistoryDialog:me,ElementDetailRefs:ve,ElementDetailItem:Ve},inject:["closeView"],props:{item:{type:Object,required:!0}},data:()=>({assets:{},changed:!1,error:!1,publishAt:null,pubmenu:!1,vhistory:!1,tab:"element"}),setup(){const e=te(),t=R();return{auth:k(),drawer:t,messages:e}},created(){var e;!((e=this.item)!=null&&e.id)||!this.auth.can("element:view")||this.$apollo.query({query:V`query($id: ID!) {
          element(id: $id) {
            id
            files {
              id
              mime
              name
              path
              previews
              updated_at
              editor
            }
            latest {
              id
              published
              data
              editor
              created_at
              files {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }
          }
        }`,variables:{id:this.item.id}}).then(t=>{var m;if(t.errors||!t.data.element)throw t;const s=[],n=t.data.element;this.reset(),this.assets={};for(const i of((m=n.latest)==null?void 0:m.files)||n.files||[])this.assets[i.id]={...i,previews:JSON.parse(i.previews||"{}")},s.push(i.id);this.item.files=s}).catch(t=>{this.messages.add(this.$gettext("Error fetching element"),"error"),this.$log("ElementDetail::watch(item): Error fetching element",t)})},methods:{publish(e=null){if(!this.auth.can("element:publish")){this.messages.add(this.$gettext("Permission denied"),"error");return}this.save(!0).then(t=>{var s,n;t&&this.$apollo.mutate({mutation:V`mutation ($id: [ID!]!, $at: DateTime) {
              pubElement(id: $id, at: $at) {
                id
              }
            }`,variables:{id:[this.item.id],at:(n=(s=e==null?void 0:e.toISOString())==null?void 0:s.substring(0,19))==null?void 0:n.replace("T"," ")}}).then(m=>{if(m.errors)throw m.errors;e?(this.item.publish_at=e,this.messages.add(this.$gettext("Element scheduled for publishing at %{date}",{date:e.toLocaleDateString()}),"info")):(this.item.published=!0,this.messages.add(this.$gettext("Element published successfully"),"success")),this.closeView()}).catch(m=>{this.messages.add(this.$gettext("Error publishing element"),"error"),this.$log("ElementDetail::publish(): Error publishing element",e,m)})})},reset(){this.changed=!1,this.error=!1},save(e=!1){return this.auth.can("element:save")?this.changed?this.$apollo.mutate({mutation:V`mutation ($id: ID!, $input: ElementInput!, $files: [ID!]) {
            saveElement(id: $id, input: $input, files: $files) {
              id
            }
          }`,variables:{id:this.item.id,input:{type:this.item.type,name:this.item.name,lang:this.item.lang,data:JSON.stringify(this.item.data||{})},files:this.item.files.filter((t,s,n)=>n.indexOf(t)===s)}}).then(t=>{if(t.errors)throw t.errors;return this.item.published=!1,this.reset(),e||this.messages.add(this.$gettext("Element saved successfully"),"success"),!0}).catch(t=>{this.messages.add(this.$gettext("Error saving element"),"error"),this.$log("ElementDetail::save(): Error saving element",t)}):Promise.resolve(!0):(this.messages.add(this.$gettext("Permission denied"),"error"),Promise.resolve(!1))},use(e){Object.assign(this.item,e.data),this.vhistory=!1,this.changed=!0},versions(e){return this.auth.can("element:view")?e?this.$apollo.query({query:V`query($id: ID!) {
            element(id: $id) {
              id
              versions {
                id
                published
                publish_at
                data
                editor
                created_at
                files {
                  id
                }
              }
            }
          }`,variables:{id:e}}).then(t=>{if(t.errors||!t.data.element)throw t;return(t.data.element.versions||[]).map(s=>({...s,data:JSON.parse(s.data||"{}"),files:s.files.map(n=>n.id)})).reverse()}).catch(t=>{this.messages.add(this.$gettext("Error fetching element versions"),"error"),this.$log("ElementDetail::versions(): Error fetching element versions",e,t)}):Promise.resolve([]):(this.messages.add(this.$gettext("Permission denied"),"error"),Promise.resolve([]))}}},Ee={class:"app-title"},we={class:"menu-content"};function De(e,t,s,n,m,i){const p=v("ElementDetailItem"),u=v("ElementDetailRefs"),h=v("AsideMeta"),S=v("HistoryDialog");return f(),c(w,null,[l(M,{elevation:0,density:"compact"},{prepend:a(()=>[l(b,{icon:"mdi-keyboard-backspace",onClick:t[0]||(t[0]=r=>i.closeView()),elevation:"0"})]),append:a(()=>[l(b,{icon:"mdi-history",class:E(["no-rtl",{hidden:s.item.published&&!e.changed&&!s.item.latest}]),onClick:t[1]||(t[1]=r=>e.vhistory=!0),elevation:"0"},null,8,["class"]),l(b,{class:E([{error:e.error},"menu-save"]),disabled:!e.changed||e.error||!n.auth.can("element:save"),onClick:t[2]||(t[2]=r=>i.save()),variant:"text"},{default:a(()=>[g(d(e.$gettext("Save")),1)]),_:1},8,["class","disabled"]),l(ae,{modelValue:e.pubmenu,"onUpdate:modelValue":t[6]||(t[6]=r=>e.pubmenu=r),"close-on-content-click":!1},{activator:a(({props:r})=>[l(ie,{class:"menu-publish",variant:"text"},{default:a(()=>[l(b,{class:E([{error:e.error},"button"]),disabled:s.item.published&&!e.changed||e.error||!n.auth.can("element:publish"),onClick:t[3]||(t[3]=y=>i.publish())},{default:a(()=>[g(d(e.$gettext("Publish")),1)]),_:1},8,["class","disabled"]),l(b,ne({class:[{error:e.error},"icon"],icon:"mdi-menu-down",disabled:s.item.published&&!e.changed||e.error||!n.auth.can("element:publish")},r),null,16,["class","disabled"])]),_:2},1024)]),default:a(()=>[o("div",we,[l(se,{modelValue:e.publishAt,"onUpdate:modelValue":t[4]||(t[4]=r=>e.publishAt=r),"hide-header":"","show-adjacent-months":""},null,8,["modelValue"]),l(b,{disabled:!e.publishAt||e.error,color:e.publishAt?"primary":"",onClick:t[5]||(t[5]=r=>{i.publish(e.publishAt),e.pubmenu=!1}),variant:"flat"},{default:a(()=>[g(d(e.$gettext("Publish")),1)]),_:1},8,["disabled","color"])])]),_:1},8,["modelValue"]),l(b,{onClick:t[7]||(t[7]=r=>n.drawer.toggle("aside"))},{default:a(()=>[l(A,{size:"x-large"},{default:a(()=>[g(d(n.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1})]),default:a(()=>[l(J,null,{default:a(()=>[o("div",Ee,d(e.$gettext("Element"))+": "+d(s.item.name),1)]),_:1})]),_:1}),l(z,{class:"element-details"},{default:a(()=>[l(re,{onSubmit:t[12]||(t[12]=de(()=>{},["prevent"]))},{default:a(()=>[l(oe,{"fixed-tabs":"",modelValue:e.tab,"onUpdate:modelValue":t[8]||(t[8]=r=>e.tab=r)},{default:a(()=>[l(j,{value:"element",class:E({changed:e.changed,error:e.error})},{default:a(()=>[g(d(e.$gettext("Element")),1)]),_:1},8,["class"]),l(j,{value:"refs"},{default:a(()=>[g(d(e.$gettext("Used by")),1)]),_:1})]),_:1},8,["modelValue"]),l(ue,{modelValue:e.tab,"onUpdate:modelValue":t[11]||(t[11]=r=>e.tab=r)},{default:a(()=>[l(B,{value:"element"},{default:a(()=>[l(p,{item:s.item,assets:e.assets,"onUpdate:item":t[9]||(t[9]=r=>{this.$emit("update:item",s.item),e.changed=!0}),onError:t[10]||(t[10]=r=>e.error=r)},null,8,["item","assets"])]),_:1}),l(B,{value:"refs"},{default:a(()=>[l(u,{item:s.item},null,8,["item"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(h,{item:s.item},null,8,["item"]),(f(),$(le,{to:"body"},[l(S,{modelValue:e.vhistory,"onUpdate:modelValue":t[13]||(t[13]=r=>e.vhistory=r),current:{data:{lang:s.item.lang,type:s.item.type,name:s.item.name,data:s.item.data},files:s.item.files},load:()=>i.versions(s.item.id),onUse:t[14]||(t[14]=r=>i.use(r)),onRevert:t[15]||(t[15]=r=>{i.use(r),i.reset()})},null,8,["modelValue","current","load"])]))],64)}const F=D($e,[["render",De],["__scopeId","data-v-ff11b317"]]),ke={components:{ElementListItems:ge,ElementDetail:F,Navigation:K,AsideList:G,User:W},inject:["locales","openView"],data:()=>({aside:null,filter:{trashed:"WITHOUT",publish:null,editor:null,lang:null}}),setup(){const e=R();return{auth:k(),drawer:e}},methods:{languages(){const e=[{title:this.$gettext("All"),icon:"mdi-playlist-check",value:{lang:null}}];for(const t of this.locales())e.push({title:t.title,icon:"mdi-translate",value:{lang:t.value}});return e},open(e){this.openView(F,{item:e})}}};function Se(e,t,s,n,m,i){var r;const p=v("User"),u=v("Navigation"),h=v("ElementListItems"),S=v("AsideList");return f(),c(w,null,[l(M,{elevation:0,density:"compact"},{prepend:a(()=>[l(b,{onClick:t[0]||(t[0]=y=>n.drawer.toggle("nav"))},{default:a(()=>[l(A,{size:"x-large"},{default:a(()=>[g(d(n.drawer.nav?"mdi-close":"mdi-menu"),1)]),_:1})]),_:1})]),append:a(()=>[l(p),l(b,{onClick:t[1]||(t[1]=y=>n.drawer.toggle("aside"))},{default:a(()=>[l(A,{size:"x-large"},{default:a(()=>[g(d(n.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1})]),default:a(()=>[l(J,null,{default:a(()=>[g(d(e.$gettext("Shared elements")),1)]),_:1})]),_:1}),l(u),l(z,{class:"element-list"},{default:a(()=>[l(U,null,{default:a(()=>[l(T,{class:"box"},{default:a(()=>[l(h,{filter:e.filter,onSelect:t[2]||(t[2]=y=>i.open(y))},null,8,["filter"])]),_:1})]),_:1})]),_:1}),l(S,{filter:e.filter,"onUpdate:filter":t[3]||(t[3]=y=>e.filter=y),content:[{key:"publish",title:e.$gettext("Publish"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{publish:null}},{title:e.$gettext("Published"),icon:"mdi-publish",value:{publish:"PUBLISHED"}},{title:e.$gettext("Scheduled"),icon:"mdi-clock-outline",value:{publish:"SCHEDULED"}},{title:e.$gettext("Drafts"),icon:"mdi-pencil",value:{publish:"DRAFT"}}]},{key:"trashed",title:e.$gettext("Trashed"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{trashed:"WITH"}},{title:e.$gettext("Available only"),icon:"mdi-delete-off",value:{trashed:"WITHOUT"}},{title:e.$gettext("Only trashed"),icon:"mdi-delete",value:{trashed:"ONLY"}}]},{key:"editor",title:e.$gettext("Editor"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{editor:null}},{title:e.$gettext("Edited by me"),icon:"mdi-account",value:{editor:(r=this.auth.me)==null?void 0:r.email}}]},{key:"lang",title:e.$gettext("Languages"),items:i.languages()}]},null,8,["filter","content"])],64)}const Pe=D(ke,[["render",Se],["__scopeId","data-v-f6a6bcbd"]]);export{Pe as default};
