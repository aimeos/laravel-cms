import{U as z,A as J,N as G}from"./Navigation-CDgZag7p.js";import{F as Y,E as K}from"./ElementListItems-D4pj1S7F.js";import{_ as D,I as c,$ as k,b as V,w as s,aP as U,o as f,a as l,aQ as P,a2 as Q,d as T,a4 as C,a5 as L,j as h,a6 as N,b4 as _,f as d,c as y,F as w,a1 as O,t as b,aE as F,aN as X,aK as Z,a0 as x,r as g,V as $,e as I,D as ee,ad as te,an as le,aJ as H,aW as R,aX as M,T as ae,aY as W,a3 as v,as as E,G as se,W as ie,aZ as ne,E as re,i as A,at as de,h as oe,aS as ue,aT as q,aU as me,aV as j}from"../index.js";import{H as fe,A as he}from"./HistoryDialog-CI7a4V_R.js";const pe={props:{item:{type:Object,required:!0}},emits:[],data:()=>({panel:[0,1,2],versions:{},element:{}}),setup(){return{auth:k()}},watch:{item:{immediate:!0,handler(t){!t.id||!this.auth.can("element:view")||this.$apollo.query({query:c`query ($id: ID!) {
              element(id: $id) {
                id
                bypages {
                  id
                  path
                  name
                }
                byversions {
                  id
                  versionable_id
                  versionable_type
                  published
                  publish_at
                }
              }
            }`,variables:{id:t.id}}).then(e=>{var a,r,u;if(e.errors)throw e.errors;this.element=((a=e.data)==null?void 0:a.element)||{},this.versions=(((u=(r=e.data)==null?void 0:r.element)==null?void 0:u.byversions)||[]).map(i=>({id:i.versionable_id,type:i.versionable_type.split("\\").at(-1),published:i.published?"yes":i.publish_at?new Date(i.publish_at).toLocaleDateString():"no"})).filter(i=>this.auth.can(i.type.toLowerCase()+":view"))}).catch(e=>{this.$log("ElementDetailRef::watch(item): Error fetching element",t,e)})}}}};function be(t,e,a,r,u,i){return f(),V(U,null,{default:s(()=>[l(P,null,{default:s(()=>[l(Q,{modelValue:t.panel,"onUpdate:modelValue":e[0]||(e[0]=p=>t.panel=p),elevation:"0",multiple:""},{default:s(()=>{var p,o;return[(p=t.element.bypages)!=null&&p.length&&r.auth.can("page:view")?(f(),V(C,{key:0},{default:s(()=>[l(L,null,{default:s(()=>e[1]||(e[1]=[h("Pages")])),_:1,__:[1]}),l(N,null,{default:s(()=>[l(_,{density:"comfortable",hover:""},{default:s(()=>[e[2]||(e[2]=d("thead",null,[d("tr",null,[d("th",null,"ID"),d("th",null,"URL"),d("th",null,"Name")])],-1)),d("tbody",null,[(f(!0),y(w,null,O(t.element.bypages,m=>(f(),y("tr",{key:m.id},[d("td",null,b(m.id),1),d("td",null,b(m.path),1),d("td",null,b(m.name),1)]))),128))])]),_:1,__:[2]})]),_:1})]),_:1})):T("",!0),(o=t.versions)!=null&&o.length?(f(),V(C,{key:1},{default:s(()=>[l(L,null,{default:s(()=>e[3]||(e[3]=[h("Versions")])),_:1,__:[3]}),l(N,null,{default:s(()=>[l(_,{density:"comfortable",hover:""},{default:s(()=>[e[4]||(e[4]=d("thead",null,[d("tr",null,[d("th",null,"ID"),d("th",null,"Type"),d("th",null,"Published")])],-1)),d("tbody",null,[(f(!0),y(w,null,O(t.versions,m=>(f(),y("tr",{key:m.id},[d("td",null,b(m.id),1),d("td",null,b(m.type),1),d("td",null,b(m.published),1)]))),128))])]),_:1,__:[4]})]),_:1})]),_:1})):T("",!0)]}),_:1},8,["modelValue"])]),_:1})]),_:1})}const ve=D(pe,[["render",be],["__scopeId","data-v-50b68922"]]),ge={components:{Fields:Y},props:{item:{type:Object,required:!0},assets:{type:Object,default:()=>{}}},emits:["update:item","error"],setup(){const t=F(),e=X(),a=Z(),r=k();return{app:x(),auth:r,languages:t,schemas:e,side:a}},computed:{langs(){const t=[{code:null,name:"None"}];return Object.entries(this.languages.available).forEach(e=>{t.push({code:e[0],name:e[1]})}),t},readonly(){return!this.auth.can("element:save")}},methods:{fields(t){var e,a;return t?(e=this.schemas.content[t])!=null&&e.fields?(a=this.schemas.content[t])==null?void 0:a.fields:(console.warn(`No definition of fields for "${t}" schemas`),[]):[]},update(t,e){this.item[t]=e,this.$emit("update:item",this.item)}}};function ye(t,e,a,r,u,i){const p=g("Fields");return f(),V(U,null,{default:s(()=>[l(P,null,{default:s(()=>[l($,null,{default:s(()=>[l(I,{cols:"12",md:"6"},{default:s(()=>[l(ee,{ref:"name",readonly:i.readonly,modelValue:a.item.name,"onUpdate:modelValue":e[0]||(e[0]=o=>i.update("name",o)),variant:"underlined",label:"Name",counter:"255",maxlength:"255"},null,8,["readonly","modelValue"])]),_:1}),l(I,{cols:"12",md:"6"},{default:s(()=>[l(te,{ref:"lang",items:i.langs,readonly:i.readonly,modelValue:a.item.lang,"onUpdate:modelValue":e[1]||(e[1]=o=>i.update("lang",o)),variant:"underlined","item-title":"name","item-value":"code",label:"Language"},null,8,["items","readonly","modelValue"])]),_:1})]),_:1}),l($,null,{default:s(()=>[l(I,{cols:"12"},{default:s(()=>[l(p,{ref:"field",data:a.item.data,"onUpdate:data":e[2]||(e[2]=o=>a.item.data=o),files:a.item.files,"onUpdate:files":e[3]||(e[3]=o=>a.item.files=o),fields:i.fields(a.item.type),readonly:i.readonly,assets:a.assets,onError:e[4]||(e[4]=o=>t.$emit("error",o)),onChange:e[5]||(e[5]=o=>t.$emit("update:item",a.item))},null,8,["data","files","fields","readonly","assets"])]),_:1})]),_:1})]),_:1})]),_:1})}const ce=D(ge,[["render",ye]]),Ve={components:{AsideMeta:he,HistoryDialog:fe,ElementDetailRefs:ve,ElementDetailItem:ce},inject:["closeView"],props:{item:{type:Object,required:!0}},data:()=>({assets:{},changed:!1,error:!1,publishAt:null,pubmenu:!1,vhistory:!1,tab:"element"}),setup(){const t=le(),e=H();return{auth:k(),drawer:e,messages:t}},created(){var t;!((t=this.item)!=null&&t.id)||!this.auth.can("element:view")||this.$apollo.query({query:c`query($id: ID!) {
          element(id: $id) {
            id
            files {
              id
              mime
              name
              path
              previews
              updated_at
              editor
            }
            latest {
              id
              published
              data
              editor
              created_at
              files {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }
          }
        }`,variables:{id:this.item.id}}).then(e=>{var u;if(e.errors||!e.data.element)throw e;const a=[],r=e.data.element;this.reset(),this.assets={};for(const i of((u=r.latest)==null?void 0:u.files)||r.files||[])this.assets[i.id]={...i,previews:JSON.parse(i.previews||"{}")},a.push(i.id);this.item.files=a}).catch(e=>{this.messages.add("Error fetching element","error"),this.$log("ElementDetail::watch(item): Error fetching element",e)})},methods:{publish(t=null){if(!this.auth.can("element:publish")){this.messages.add("Permission denied","error");return}this.save(!0).then(e=>{var a,r;e&&this.$apollo.mutate({mutation:c`mutation ($id: [ID!]!, $at: DateTime) {
              pubElement(id: $id, at: $at) {
                id
              }
            }`,variables:{id:[this.item.id],at:(r=(a=t==null?void 0:t.toISOString())==null?void 0:a.substring(0,19))==null?void 0:r.replace("T"," ")}}).then(u=>{if(u.errors)throw u.errors;t?(this.item.publish_at=t,this.messages.add(`Element scheduled for publishing at ${t.toLocaleDateString()}`,"info")):(this.item.published=!0,this.messages.add("Element published successfully","success")),this.closeView()}).catch(u=>{this.messages.add("Error publishing element","error"),this.$log("ElementDetail::publish(): Error publishing element",t,u)})})},reset(){this.changed=!1,this.error=!1},save(t=!1){return this.auth.can("element:save")?this.changed?this.$apollo.mutate({mutation:c`mutation ($id: ID!, $input: ElementInput!, $files: [ID!]) {
            saveElement(id: $id, input: $input, files: $files) {
              id
            }
          }`,variables:{id:this.item.id,input:{type:this.item.type,name:this.item.name,lang:this.item.lang,data:JSON.stringify(this.item.data||{})},files:this.item.files.filter((e,a,r)=>r.indexOf(e)===a)}}).then(e=>{if(e.errors)throw e.errors;return this.item.published=!1,this.reset(),t||this.messages.add("Element saved successfully","success"),!0}).catch(e=>{this.messages.add("Error saving element","error"),this.$log("ElementDetail::save(): Error saving element",e)}):Promise.resolve(!0):(this.messages.add("Permission denied","error"),Promise.resolve(!1))},use(t){Object.assign(this.item,t.data),this.vhistory=!1,this.changed=!0},versions(t){return this.auth.can("element:view")?t?this.$apollo.query({query:c`query($id: ID!) {
            element(id: $id) {
              id
              versions {
                id
                published
                publish_at
                data
                editor
                created_at
                files {
                  id
                }
              }
            }
          }`,variables:{id:t}}).then(e=>{if(e.errors||!e.data.element)throw e;return(e.data.element.versions||[]).map(a=>({...a,data:JSON.parse(a.data||"{}"),files:a.files.map(r=>r.id)})).reverse()}).catch(e=>{this.messages.add("Error fetching element versions","error"),this.$log("ElementDetail::versions(): Error fetching element versions",t,e)}):Promise.resolve([]):(this.messages.add("Permission denied","error"),Promise.resolve([]))}}},Ee={class:"app-title"},we={class:"menu-content"};function De(t,e,a,r,u,i){const p=g("ElementDetailItem"),o=g("ElementDetailRefs"),m=g("AsideMeta"),S=g("HistoryDialog");return f(),y(w,null,[l(R,{elevation:0,density:"compact"},{prepend:s(()=>[l(v,{icon:"mdi-keyboard-backspace",onClick:e[0]||(e[0]=n=>i.closeView()),elevation:"0"})]),append:s(()=>[l(v,{icon:"mdi-history",class:E({hidden:a.item.published&&!t.changed&&!a.item.latest}),onClick:e[1]||(e[1]=n=>t.vhistory=!0),elevation:"0"},null,8,["class"]),l(v,{class:E([{error:t.error},"menu-save"]),disabled:!t.changed||t.error||!r.auth.can("element:save"),onClick:e[2]||(e[2]=n=>i.save()),variant:"text"},{default:s(()=>e[16]||(e[16]=[h("Save")])),_:1,__:[16]},8,["class","disabled"]),l(se,{modelValue:t.pubmenu,"onUpdate:modelValue":e[6]||(e[6]=n=>t.pubmenu=n),"close-on-content-click":!1},{activator:s(({props:n})=>[l(ne,{class:"menu-publish",variant:"text"},{default:s(()=>[l(v,{class:E([{error:t.error},"button"]),disabled:a.item.published&&!t.changed||t.error||!r.auth.can("element:publish"),onClick:e[3]||(e[3]=Ie=>i.publish())},{default:s(()=>e[17]||(e[17]=[h("Publish")])),_:1,__:[17]},8,["class","disabled"]),l(v,re({class:[{error:t.error},"icon"],icon:"mdi-menu-down",disabled:a.item.published&&!t.changed||t.error||!r.auth.can("element:publish")},n),null,16,["class","disabled"])]),_:2},1024)]),default:s(()=>[d("div",we,[l(ie,{modelValue:t.publishAt,"onUpdate:modelValue":e[4]||(e[4]=n=>t.publishAt=n),"hide-header":"","show-adjacent-months":""},null,8,["modelValue"]),l(v,{disabled:!t.publishAt||t.error,color:t.publishAt?"primary":"",onClick:e[5]||(e[5]=n=>{i.publish(t.publishAt),t.pubmenu=!1}),variant:"flat"},{default:s(()=>e[18]||(e[18]=[h("Publish")])),_:1,__:[18]},8,["disabled","color"])])]),_:1},8,["modelValue"]),l(v,{onClick:e[7]||(e[7]=n=>r.drawer.toggle("aside"))},{default:s(()=>[l(A,{size:"x-large"},{default:s(()=>[h(b(r.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1})]),default:s(()=>[l(W,null,{default:s(()=>[d("div",Ee," Element: "+b(a.item.name),1)]),_:1})]),_:1}),l(M,{class:"element-details"},{default:s(()=>[l(de,{onSubmit:e[12]||(e[12]=oe(()=>{},["prevent"]))},{default:s(()=>[l(ue,{"fixed-tabs":"",modelValue:t.tab,"onUpdate:modelValue":e[8]||(e[8]=n=>t.tab=n)},{default:s(()=>[l(q,{value:"element",class:E({changed:t.changed,error:t.error})},{default:s(()=>e[19]||(e[19]=[h("Element")])),_:1,__:[19]},8,["class"]),l(q,{value:"refs"},{default:s(()=>e[20]||(e[20]=[h("Used by")])),_:1,__:[20]})]),_:1},8,["modelValue"]),l(me,{modelValue:t.tab,"onUpdate:modelValue":e[11]||(e[11]=n=>t.tab=n)},{default:s(()=>[l(j,{value:"element"},{default:s(()=>[l(p,{item:a.item,assets:t.assets,"onUpdate:item":e[9]||(e[9]=n=>{this.$emit("update:item",a.item),t.changed=!0}),onError:e[10]||(e[10]=n=>t.error=n)},null,8,["item","assets"])]),_:1}),l(j,{value:"refs"},{default:s(()=>[l(o,{item:a.item},null,8,["item"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(m,{item:a.item},null,8,["item"]),(f(),V(ae,{to:"body"},[l(S,{modelValue:t.vhistory,"onUpdate:modelValue":e[13]||(e[13]=n=>t.vhistory=n),current:{data:{lang:a.item.lang,type:a.item.type,name:a.item.name,data:a.item.data},files:a.item.files},load:()=>i.versions(a.item.id),onUse:e[14]||(e[14]=n=>i.use(n)),onRevert:e[15]||(e[15]=n=>{i.use(n),i.reset()})},null,8,["modelValue","current","load"])]))],64)}const B=D(Ve,[["render",De],["__scopeId","data-v-3d412111"]]),ke={components:{ElementListItems:K,ElementDetail:B,Navigation:G,AsideList:J,User:z},inject:["openView"],data:()=>({aside:null,filter:{trashed:"WITHOUT",publish:null,editor:null,lang:null}}),setup(){const t=F(),e=H();return{auth:k(),drawer:e,languages:t}},methods:{languages(){const t=[{title:"All",icon:"mdi-playlist-check",value:{lang:null}}];for(const e in this.languages.available)t.push({title:this.languages.available[e],icon:"mdi-translate",value:{lang:e}});return t},open(t){this.openView(B,{item:t})}}};function Se(t,e,a,r,u,i){const p=g("User"),o=g("Navigation"),m=g("ElementListItems"),S=g("AsideList");return f(),y(w,null,[l(R,{elevation:0,density:"compact"},{prepend:s(()=>[l(v,{onClick:e[0]||(e[0]=n=>r.drawer.toggle("nav"))},{default:s(()=>[l(A,{size:"x-large"},{default:s(()=>[h(b(r.drawer.nav?"mdi-close":"mdi-menu"),1)]),_:1})]),_:1})]),append:s(()=>[l(p),l(v,{onClick:e[1]||(e[1]=n=>r.drawer.toggle("aside"))},{default:s(()=>[l(A,{size:"x-large"},{default:s(()=>[h(b(r.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1})]),default:s(()=>[l(W,null,{default:s(()=>e[4]||(e[4]=[h("Shared elements")])),_:1,__:[4]})]),_:1}),l(o),l(M,{class:"element-list"},{default:s(()=>[l(U,null,{default:s(()=>[l(P,{class:"box"},{default:s(()=>[l(m,{filter:t.filter,onSelect:e[2]||(e[2]=n=>i.open(n))},null,8,["filter"])]),_:1})]),_:1})]),_:1}),l(S,{filter:t.filter,"onUpdate:filter":e[3]||(e[3]=n=>t.filter=n),content:[{key:"publish",items:[{title:"All",icon:"mdi-playlist-check",value:{publish:null}},{title:"Published",icon:"mdi-publish",value:{publish:"PUBLISHED"}},{title:"Scheduled",icon:"mdi-clock-outline",value:{publish:"SCHEDULED"}},{title:"Drafts",icon:"mdi-pencil",value:{publish:"DRAFT"}}]},{key:"trashed",items:[{title:"All",icon:"mdi-playlist-check",value:{trashed:"WITH"}},{title:"Available only",icon:"mdi-delete-off",value:{trashed:"WITHOUT"}},{title:"Only trashed",icon:"mdi-delete",value:{trashed:"ONLY"}}]},{key:"editor",items:[{title:"All",icon:"mdi-playlist-check",value:{editor:null}},{title:"Edited by me",icon:"mdi-account",value:{editor:this.auth.me.email}}]},{key:"lang",items:i.languages()}]},null,8,["filter","content"])],64)}const Ce=D(ke,[["render",Se],["__scopeId","data-v-4c27d2c0"]]);export{Ce as default};
