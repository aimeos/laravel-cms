import{_ as D,c as g,a as r,b as u,w as b,r as f,T as y,F,J as A,a0 as C,a1 as j,o,d as p,a2 as L,g as I,$ as O,h as R,i as _,f as k,j as v,k as x}from"../index.js";import{l as B}from"./vue-draggable-plus-wEOAkpgF.js";import{F as E}from"./FileAiDialog-BJbr4td3.js";import{F as N,a as w}from"./FileListItems-B-BtiPhP.js";import{F as P,a as M}from"./FileDialog-6fkQMmWA.js";import"./HistoryDialog-BhGSg-LU.js";const S={components:{FileDetail:w,FileDialog:M,FileAiDialog:E,FileUrlDialog:P,FileListItems:N,VueDraggable:B},inject:["openView"],props:{modelValue:{type:Array,default:()=>[]},config:{type:Object,default:()=>{}},assets:{type:Object,default:()=>{}},readonly:{type:Boolean,default:!1}},emits:["update:modelValue","error","addFile","removeFile"],setup(){const t=C();return{app:j(),auth:t}},data(){return{images:[],index:Math.floor(Math.random()*1e5),selected:null,vcreate:!1,vfiles:!1,vurls:!1}},unmounted(){this.images.forEach(t=>{var e;(e=t.path)!=null&&e.startsWith("blob:")&&URL.revokeObjectURL(t.path)})},methods:{add(t){if(!this.auth.can("file:add")){this.messages.add(this.$gettext("Permission denied"),"error");return}const e=[];t!=null&&t.length&&(Array.from(t).forEach(l=>{const c=URL.createObjectURL(l),a=this.images.length;this.images[a]={path:c,uploading:!0};const s=this.$apollo.mutate({mutation:A`mutation($file: Upload!) {
              addFile(file: $file) {
                id
                mime
                name
                path
                previews
              }
            }`,variables:{file:l},context:{hasUpload:!0}}).then(d=>{var h;if(d.errors)throw d.errors;const n=((h=d.data)==null?void 0:h.addFile)||{};return n.previews=JSON.parse(n.previews)||{},delete n.__typename,new Promise((V,i)=>{const m=new Image;m.onload=V,m.onerror=i,m.src=this.url(Object.values(n.previews)[0])}).then(()=>{this.images[a]=n,this.$emit("addFile",n.id),URL.revokeObjectURL(c)})}).catch(d=>{this.$log("Images::addFile(): Error uploading images",ev,d)});e.push(s)}),Promise.all(e).then(()=>{this.$emit("update:modelValue",this.images.map(l=>({id:l.id,type:"file"})))}),this.selected=null)},change(){this.$emit("update:modelValue",this.images.map(t=>({id:t.id,type:"file"})))},open(t){this.openView(w,{item:t})},remove(t){var e;(e=this.images[t])!=null&&e.id&&this.$emit("removeFile",this.images[t].id),this.images.splice(t,1),this.$emit("update:modelValue",this.images.map(l=>({id:l.id,type:"file"}))),this.validate()},select(t){Array.isArray(t)||(t=[t]),t.forEach(e=>{this.images.push(e),this.$emit("addFile",e.id)}),this.$emit("update:modelValue",this.images.map(e=>({id:e.id,type:"file"}))),this.vfiles=!1,this.vurls=!1,this.validate()},srcset(t){let e=[];for(const l in t)e.push(`${this.url(t[l])} ${l}w`);return e.join(", ")},url(t){return t.startsWith("http")||t.startsWith("blob:")?t:this.app.urlfile.replace(/\/+$/g,"")+"/"+t},async validate(){const t=this.images.length>=(this.config.min??0)&&this.images.length<=(this.config.max??1e3);return this.$emit("error",!t),await t}},watch:{modelValue:{immediate:!0,handler(t){if(!this.images.length)for(const e of t||[])this.assets[e.id]&&this.images.push(this.assets[e.id])}}}},W=["onClick"],J=["onClick"],T={key:0,class:"add"},q={class:"icon-group"},z={class:"icon-group"};function G(t,e,l,c,a,s){const d=f("VueDraggable"),n=f("FileDialog"),h=f("FileAiDialog"),V=f("FileUrlDialog");return o(),g(F,null,[r(d,{modelValue:a.images,"onUpdate:modelValue":e[5]||(e[5]=i=>a.images=i),disabled:l.readonly,onChange:e[6]||(e[6]=i=>s.change()),draggable:".image",group:"images",class:"images",animation:"500"},{default:b(()=>[(o(!0),g(F,null,L(a.images,(i,m)=>(o(),g("div",{key:m,class:"image",onClick:U=>s.open(i)},[i.uploading?(o(),u(I,{key:0,color:"primary",height:"5",indeterminate:"",rounded:""})):p("",!0),i.path?(o(),u(O,{key:1,srcset:s.srcset(i.previews),src:s.url(i.path),draggable:"false"},null,8,["srcset","src"])):p("",!0),!l.readonly&&i.id?(o(),g("button",{key:2,onClick:R(U=>s.remove(m),["stop"]),class:"btn-overlay",title:"Remove image",type:"button"},[r(_,{icon:"mdi-trash-can",role:"img"})],8,J)):p("",!0)],8,W))),128)),l.readonly?p("",!0):(o(),g("div",T,[k("div",q,[c.auth.can("file:view")?(o(),u(v,{key:0,icon:"mdi-button-cursor",variant:"flat",onClick:e[0]||(e[0]=i=>a.vfiles=!0)})):p("",!0),r(v,{onClick:e[1]||(e[1]=i=>a.vurls=!0),icon:"mdi-link-variant-plus",variant:"flat"})]),k("div",z,[r(v,{onClick:e[2]||(e[2]=i=>a.vcreate=!0),icon:"mdi-creation",variant:"flat"}),r(v,{icon:"mdi-upload",variant:"flat"},{default:b(()=>[r(x,{modelValue:a.selected,"onUpdate:modelValue":[e[3]||(e[3]=i=>a.selected=i),e[4]||(e[4]=i=>s.add(i))],accept:l.config.accept||"image/*","hide-input":!0,"prepend-icon":"mdi-upload",multiple:""},null,8,["modelValue","accept"])]),_:1})])]))]),_:1},8,["modelValue","disabled"]),(o(),u(y,{to:"body"},[r(n,{modelValue:a.vfiles,"onUpdate:modelValue":e[7]||(e[7]=i=>a.vfiles=i),onAdd:e[8]||(e[8]=i=>s.select(i)),filter:{mime:"image/"},grid:""},null,8,["modelValue"])])),(o(),u(y,{to:"body"},[r(h,{modelValue:a.vcreate,"onUpdate:modelValue":e[9]||(e[9]=i=>a.vcreate=i),onAdd:e[10]||(e[10]=i=>{s.select(i),a.vcreate=!1})},null,8,["modelValue"])])),(o(),u(y,{to:"body"},[r(V,{modelValue:a.vurls,"onUpdate:modelValue":e[11]||(e[11]=i=>a.vurls=i),onAdd:e[12]||(e[12]=i=>s.select(i)),mime:"image/",multiple:""},null,8,["modelValue"])]))],64)}const $=D(S,[["render",G],["__scopeId","data-v-f4211d95"]]);export{$ as default};
