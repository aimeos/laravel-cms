import{_ as w,J as $,a1 as S,b as f,w as a,a3 as I,r as D,o as s,a as l,a4 as E,a5 as A,c as p,d as b,Z as N,j as h,l as m,t as c,a6 as v,a7 as _,a8 as y,F as C,a2 as x,a9 as F,f as g}from"../index.js";import{F as O}from"./FileListItems-BgArmzs5.js";const T={components:{FileListItems:O},props:{modelValue:{type:Boolean,required:!0},context:{type:[Object,null],default:null}},emits:["update:modelValue","add"],setup(){return{app:S()}},data(){return{input:"",items:[],errors:[],similar:[],loading:!1}},methods:{add(e){this.loading=!0,fetch(this.app.urlproxy.replace(":url",encodeURIComponent(e.path)),{credentials:"include",method:"GET"}).then(t=>{if(!t.ok)throw new Error(`Failed to fetch ${e.path}`,t);return t.blob()}).then(t=>{const o=e.name.replaceAll(" ","-")+"_"+new Date().toISOString().replace(/[^0-9]/g,"")+".png";return this.$apollo.mutate({mutation:$`mutation($input: FileInput, $file: Upload) {
              addFile(input: $input, file: $file) {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }`,variables:{input:{name:e.name},file:new File([t],o,{type:e.mime})},context:{hasUpload:!0}})}).then(t=>{if(t.errors)throw t.errors;Object.assign(e,t.data.addFile,{previews:JSON.parse(t.data.addFile.previews||"{}")}),this.$emit("add",[e])}).catch(t=>{this.$log(`FileAiDialog::add(): Error adding file for ${e.path}`,t)}).finally(()=>{this.loading=!1})},create(){!this.input||this.loading||(this.loading=!0,this.original=this.input,this.$apollo.mutate({mutation:$`mutation($prompt: String!, $context: String, $images: [String!]) {
            imagine(prompt: $prompt, context: $context, images: $images)
          }`,variables:{prompt:this.input,context:this.context?$gettext("Context in JSON format")+`:
`+JSON.stringify(this.context):"",images:this.similar.map(e=>e.path)}}).then(e=>{if(e.errors)throw e.errors;const t=this.input,o=e.data.imagine;this.input=o.shift()||this.input,o.forEach(d=>{fetch(this.app.urlproxy.replace(":url",encodeURIComponent(d)),{credentials:"include",method:"HEAD"}).then(i=>{var r;if(!i.ok)throw new Error(`Failed to fetch ${d}`,i);this.items.unshift({path:d,mime:(r=i.headers)==null?void 0:r.get("Content-Type"),name:t.slice(0,t.lastIndexOf(" ",100))})}).catch(i=>{this.$log(`FileAiDialog::create(): Error fetching ${d}`,i)})})}).catch(e=>{this.$log("FileAiDialog::create(): Error creating files",e)}).finally(()=>{this.loading=!1}))},remove(e){this.items.splice(e,1)},removeSimilar(e){this.similar.splice(e,1)},url(e){return e.startsWith("http")||e.startsWith("blob:")?e:this.app.urlfile.replace(/\/+$/g,"")+"/"+e},use(e){this.similar.find(t=>t.path===e.path)||this.similar.push(e)}}},B={key:0},L=["onClick"],U=["src"],J={key:1},R={class:"item-preview"},j=["src"];function q(e,t,o,d,i,r){const k=D("FileListItems");return s(),f(I,{modelValue:o.modelValue,"max-width":"1200",scrollable:""},{default:a(()=>[l(E,{loading:i.loading?"primary":!1},{append:a(()=>[l(h,{icon:"mdi-close",variant:"flat",onClick:t[0]||(t[0]=n=>e.$emit("update:modelValue",!1))})]),title:a(()=>[m(c(e.$gettext("Create image")),1)]),default:a(()=>[l(A,null,{default:a(()=>[l(N,{modelValue:i.input,"onUpdate:modelValue":t[1]||(t[1]=n=>i.input=n),label:e.$gettext("Describe the image"),variant:"underlined",autofocus:"",clearable:""},null,8,["modelValue","label"]),l(h,{loading:i.loading?"primary":!1,disabled:!i.input||i.loading,onClick:t[2]||(t[2]=n=>r.create()),color:"primary",variant:"outlined",class:"create"},{default:a(()=>[m(c(e.$gettext("Create image")),1)]),_:1},8,["loading","disabled"]),i.items.length?(s(),p("div",B,[l(v,null,{default:a(()=>[l(_,null,{default:a(()=>[m(c(e.$gettext("Generated images")),1)]),_:1})]),_:1}),l(y,{class:"items grid"},{default:a(()=>[(s(!0),p(C,null,x(i.items,(n,u)=>(s(),f(F,{key:u},{default:a(()=>[l(h,{icon:"mdi-delete",onClick:V=>r.remove(u),class:"btn-overlay",title:e.$gettext("Remove")},null,8,["onClick","title"]),g("div",{class:"item-preview",onClick:V=>r.add(n)},[g("img",{src:r.url(n.path)},null,8,U)],8,L)]),_:2},1024))),128))]),_:1})])):b("",!0),i.similar.length?(s(),p("div",J,[l(v,null,{default:a(()=>[l(_,null,{default:a(()=>[m(c(e.$gettext("Use images of this style")),1)]),_:1})]),_:1}),l(y,{class:"items grid"},{default:a(()=>[(s(!0),p(C,null,x(i.similar,(n,u)=>(s(),f(F,{key:u},{default:a(()=>[l(h,{icon:"mdi-delete",onClick:V=>r.removeSimilar(u),class:"btn-overlay",title:e.$gettext("Remove")},null,8,["onClick","title"]),g("div",R,[g("img",{src:r.url(n.path)},null,8,j)])]),_:2},1024))),128))]),_:1})])):b("",!0),l(v,null,{default:a(()=>[l(_,null,{default:a(()=>[m(c(e.$gettext("Select similar images")),1)]),_:1})]),_:1}),l(k,{filter:{mime:"image/"},onSelect:t[3]||(t[3]=n=>r.use(n))})]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])}const H=w(T,[["render",q],["__scopeId","data-v-3e180853"]]);export{H as F};
