import{U as J,A as Y,N as G}from"./Navigation-Cr90_rXC.js";import{F as X,E as Z}from"./ElementListItems-Bv9LrEIu.js";import{_ as k,H as V,Z as S,b as E,w as s,aO as P,o as f,a as l,aP as T,a1 as K,d as C,a3 as L,a4 as N,j as h,a5 as O,b3 as _,f as d,c,F as D,a0 as $,t as b,aD as F,aM as Q,aJ as x,$ as ee,r as g,V as q,e as U,C as te,ac as le,am as ae,aI as R,aV as M,aW as W,T as se,aX as z,a2 as v,ar as w,E as ie,U as ne,aY as re,D as de,i as A,as as oe,h as ue,aR as me,aS as j,aT as fe,aU as H}from"../index.js";import{H as he,A as pe}from"./HistoryDialog-DB5QzTyj.js";const be={props:{item:{type:Object,required:!0}},emits:[],data:()=>({panel:[0,1,2],versions:{},element:{}}),setup(){return{auth:S()}},watch:{item:{immediate:!0,handler(t){!t.id||!this.auth.can("element:view")||this.$apollo.query({query:V`query ($id: ID!) {
              element(id: $id) {
                id
                bypages {
                  id
                  path
                  name
                }
                byversions {
                  id
                  versionable_id
                  versionable_type
                  published
                  publish_at
                }
              }
            }`,variables:{id:t.id}}).then(e=>{var a,n,u;if(e.errors)throw e.errors;this.element=((a=e.data)==null?void 0:a.element)||{},this.versions=(((u=(n=e.data)==null?void 0:n.element)==null?void 0:u.byversions)||[]).map(i=>({id:i.versionable_id,type:i.versionable_type.split("\\").at(-1),published:i.published?"yes":i.publish_at?new Date(i.publish_at).toLocaleDateString():"no"})).filter(i=>this.auth.can(i.type.toLowerCase()+":view"))}).catch(e=>{this.$log("ElementDetailRef::watch(item): Error fetching element",t,e)})}}}};function ve(t,e,a,n,u,i){return f(),E(P,null,{default:s(()=>[l(T,null,{default:s(()=>[l(K,{modelValue:t.panel,"onUpdate:modelValue":e[0]||(e[0]=p=>t.panel=p),elevation:"0",multiple:""},{default:s(()=>{var p,o;return[(p=t.element.bypages)!=null&&p.length&&n.auth.can("page:view")?(f(),E(L,{key:0},{default:s(()=>[l(N,null,{default:s(()=>e[1]||(e[1]=[h("Pages")])),_:1,__:[1]}),l(O,null,{default:s(()=>[l(_,{density:"comfortable",hover:""},{default:s(()=>[e[2]||(e[2]=d("thead",null,[d("tr",null,[d("th",null,"ID"),d("th",null,"URL"),d("th",null,"Name")])],-1)),d("tbody",null,[(f(!0),c(D,null,$(t.element.bypages,m=>(f(),c("tr",{key:m.id},[d("td",null,b(m.id),1),d("td",null,b(m.path),1),d("td",null,b(m.name),1)]))),128))])]),_:1,__:[2]})]),_:1})]),_:1})):C("",!0),(o=t.versions)!=null&&o.length?(f(),E(L,{key:1},{default:s(()=>[l(N,null,{default:s(()=>e[3]||(e[3]=[h("Versions")])),_:1,__:[3]}),l(O,null,{default:s(()=>[l(_,{density:"comfortable",hover:""},{default:s(()=>[e[4]||(e[4]=d("thead",null,[d("tr",null,[d("th",null,"ID"),d("th",null,"Type"),d("th",null,"Published")])],-1)),d("tbody",null,[(f(!0),c(D,null,$(t.versions,m=>(f(),c("tr",{key:m.id},[d("td",null,b(m.id),1),d("td",null,b(m.type),1),d("td",null,b(m.published),1)]))),128))])]),_:1,__:[4]})]),_:1})]),_:1})):C("",!0)]}),_:1},8,["modelValue"])]),_:1})]),_:1})}const ge=k(be,[["render",ve],["__scopeId","data-v-50b68922"]]),ye={components:{Fields:X},props:{item:{type:Object,required:!0},assets:{type:Object,default:()=>{}}},emits:["update:item","error"],setup(){const t=F(),e=Q(),a=x(),n=S();return{app:ee(),auth:n,languages:t,schemas:e,side:a}},computed:{langs(){const t=[{code:null,name:"None"}];return Object.entries(this.languages.available).forEach(e=>{t.push({code:e[0],name:e[1]})}),t},readonly(){return!this.auth.can("element:save")}},methods:{fields(t){var e,a;return t?(e=this.schemas.content[t])!=null&&e.fields?(a=this.schemas.content[t])==null?void 0:a.fields:(console.warn(`No definition of fields for "${t}" schemas`),[]):[]},update(t,e){this.item[t]=e,this.$emit("update:item",this.item)}}};function ce(t,e,a,n,u,i){const p=g("Fields");return f(),E(P,null,{default:s(()=>[l(T,null,{default:s(()=>[l(q,null,{default:s(()=>[l(U,{cols:"12",md:"6"},{default:s(()=>[l(te,{ref:"name",readonly:i.readonly,modelValue:a.item.name,"onUpdate:modelValue":e[0]||(e[0]=o=>i.update("name",o)),variant:"underlined",label:"Name",counter:"255",maxlength:"255"},null,8,["readonly","modelValue"])]),_:1}),l(U,{cols:"12",md:"6"},{default:s(()=>[l(le,{ref:"lang",items:i.langs,readonly:i.readonly,modelValue:a.item.lang,"onUpdate:modelValue":e[1]||(e[1]=o=>i.update("lang",o)),variant:"underlined","item-title":"name","item-value":"code",label:"Language"},null,8,["items","readonly","modelValue"])]),_:1})]),_:1}),l(q,null,{default:s(()=>[l(U,{cols:"12"},{default:s(()=>[l(p,{ref:"field",data:a.item.data,"onUpdate:data":e[2]||(e[2]=o=>a.item.data=o),files:a.item.files,"onUpdate:files":e[3]||(e[3]=o=>a.item.files=o),fields:i.fields(a.item.type),readonly:i.readonly,assets:a.assets,onError:e[4]||(e[4]=o=>t.$emit("error",o)),onChange:e[5]||(e[5]=o=>t.$emit("update:item",a.item))},null,8,["data","files","fields","readonly","assets"])]),_:1})]),_:1})]),_:1})]),_:1})}const Ve=k(ye,[["render",ce]]),Ee={components:{AsideMeta:pe,HistoryDialog:he,ElementDetailRefs:ge,ElementDetailItem:Ve},inject:["closeView"],props:{item:{type:Object,required:!0}},data:()=>({assets:{},changed:!1,error:!1,publishAt:null,pubmenu:!1,vhistory:!1,tab:"element"}),setup(){const t=ae(),e=R();return{auth:S(),drawer:e,messages:t}},created(){var t;!((t=this.item)!=null&&t.id)||!this.auth.can("element:view")||this.$apollo.query({query:V`query($id: ID!) {
          element(id: $id) {
            id
            files {
              id
              mime
              name
              path
              previews
              updated_at
              editor
            }
            latest {
              id
              published
              data
              editor
              created_at
              files {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }
          }
        }`,variables:{id:this.item.id}}).then(e=>{var u;if(e.errors||!e.data.element)throw e;const a=[],n=e.data.element;this.reset(),this.assets={};for(const i of((u=n.latest)==null?void 0:u.files)||n.files||[])this.assets[i.id]={...i,previews:JSON.parse(i.previews||"{}")},a.push(i.id);this.item.files=a}).catch(e=>{this.messages.add("Error fetching element","error"),this.$log("ElementDetail::watch(item): Error fetching element",e)})},methods:{publish(t=null){if(!this.auth.can("element:publish")){this.messages.add("Permission denied","error");return}this.save(!0).then(e=>{var a,n;e&&this.$apollo.mutate({mutation:V`mutation ($id: [ID!]!, $at: DateTime) {
              pubElement(id: $id, at: $at) {
                id
              }
            }`,variables:{id:[this.item.id],at:(n=(a=t==null?void 0:t.toISOString())==null?void 0:a.substring(0,19))==null?void 0:n.replace("T"," ")}}).then(u=>{if(u.errors)throw u.errors;t?(this.item.publish_at=t,this.messages.add(`Element scheduled for publishing at ${t.toLocaleDateString()}`,"info")):(this.item.published=!0,this.messages.add("Element published successfully","success")),this.closeView()}).catch(u=>{this.messages.add("Error publishing element","error"),this.$log("ElementDetail::publish(): Error publishing element",t,u)})})},reset(){this.changed=!1,this.error=!1},save(t=!1){return this.auth.can("element:save")?this.changed?this.$apollo.mutate({mutation:V`mutation ($id: ID!, $input: ElementInput!, $files: [ID!]) {
            saveElement(id: $id, input: $input, files: $files) {
              id
            }
          }`,variables:{id:this.item.id,input:{type:this.item.type,name:this.item.name,lang:this.item.lang,data:JSON.stringify(this.item.data||{})},files:this.item.files.filter((e,a,n)=>n.indexOf(e)===a)}}).then(e=>{if(e.errors)throw e.errors;return this.item.published=!1,this.reset(),t||this.messages.add("Element saved successfully","success"),!0}).catch(e=>{this.messages.add("Error saving element","error"),this.$log("ElementDetail::save(): Error saving element",e)}):Promise.resolve(!0):(this.messages.add("Permission denied","error"),Promise.resolve(!1))},use(t){Object.assign(this.item,t.data),this.vhistory=!1,this.changed=!0},versions(t){return this.auth.can("element:view")?t?this.$apollo.query({query:V`query($id: ID!) {
            element(id: $id) {
              id
              versions {
                id
                published
                publish_at
                data
                editor
                created_at
                files {
                  id
                }
              }
            }
          }`,variables:{id:t}}).then(e=>{if(e.errors||!e.data.element)throw e;return(e.data.element.versions||[]).map(a=>({...a,data:JSON.parse(a.data||"{}"),files:a.files.map(n=>n.id)})).reverse()}).catch(e=>{this.messages.add("Error fetching element versions","error"),this.$log("ElementDetail::versions(): Error fetching element versions",t,e)}):Promise.resolve([]):(this.messages.add("Permission denied","error"),Promise.resolve([]))}}},we={class:"app-title"},De={class:"menu-content"};function ke(t,e,a,n,u,i){const p=g("ElementDetailItem"),o=g("ElementDetailRefs"),m=g("AsideMeta"),I=g("HistoryDialog");return f(),c(D,null,[l(M,{elevation:0,density:"compact"},{prepend:s(()=>[l(v,{icon:"mdi-keyboard-backspace",onClick:e[0]||(e[0]=r=>i.closeView()),elevation:"0"})]),append:s(()=>[l(v,{icon:"mdi-history",class:w({hidden:a.item.published&&!t.changed&&!a.item.latest}),onClick:e[1]||(e[1]=r=>t.vhistory=!0),elevation:"0"},null,8,["class"]),l(v,{class:w([{error:t.error},"menu-save"]),disabled:!t.changed||t.error||!n.auth.can("element:save"),onClick:e[2]||(e[2]=r=>i.save()),variant:"text"},{default:s(()=>e[16]||(e[16]=[h("Save")])),_:1,__:[16]},8,["class","disabled"]),l(ie,{modelValue:t.pubmenu,"onUpdate:modelValue":e[6]||(e[6]=r=>t.pubmenu=r),"close-on-content-click":!1},{activator:s(({props:r})=>[l(re,{class:"menu-publish",variant:"text"},{default:s(()=>[l(v,{class:w([{error:t.error},"button"]),disabled:a.item.published&&!t.changed||t.error||!n.auth.can("element:publish"),onClick:e[3]||(e[3]=y=>i.publish())},{default:s(()=>e[17]||(e[17]=[h("Publish")])),_:1,__:[17]},8,["class","disabled"]),l(v,de({class:[{error:t.error},"icon"],icon:"mdi-menu-down",disabled:a.item.published&&!t.changed||t.error||!n.auth.can("element:publish")},r),null,16,["class","disabled"])]),_:2},1024)]),default:s(()=>[d("div",De,[l(ne,{modelValue:t.publishAt,"onUpdate:modelValue":e[4]||(e[4]=r=>t.publishAt=r),"hide-header":"","show-adjacent-months":""},null,8,["modelValue"]),l(v,{disabled:!t.publishAt||t.error,color:t.publishAt?"primary":"",onClick:e[5]||(e[5]=r=>{i.publish(t.publishAt),t.pubmenu=!1}),variant:"flat"},{default:s(()=>e[18]||(e[18]=[h("Publish")])),_:1,__:[18]},8,["disabled","color"])])]),_:1},8,["modelValue"]),l(v,{onClick:e[7]||(e[7]=r=>n.drawer.toggle("aside"))},{default:s(()=>[l(A,{size:"x-large"},{default:s(()=>[h(b(n.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1})]),default:s(()=>[l(z,null,{default:s(()=>[d("div",we," Element: "+b(a.item.name),1)]),_:1})]),_:1}),l(W,{class:"element-details"},{default:s(()=>[l(oe,{onSubmit:e[12]||(e[12]=ue(()=>{},["prevent"]))},{default:s(()=>[l(me,{"fixed-tabs":"",modelValue:t.tab,"onUpdate:modelValue":e[8]||(e[8]=r=>t.tab=r)},{default:s(()=>[l(j,{value:"element",class:w({changed:t.changed,error:t.error})},{default:s(()=>e[19]||(e[19]=[h("Element")])),_:1,__:[19]},8,["class"]),l(j,{value:"refs"},{default:s(()=>e[20]||(e[20]=[h("Used by")])),_:1,__:[20]})]),_:1},8,["modelValue"]),l(fe,{modelValue:t.tab,"onUpdate:modelValue":e[11]||(e[11]=r=>t.tab=r)},{default:s(()=>[l(H,{value:"element"},{default:s(()=>[l(p,{item:a.item,assets:t.assets,"onUpdate:item":e[9]||(e[9]=r=>{this.$emit("update:item",a.item),t.changed=!0}),onError:e[10]||(e[10]=r=>t.error=r)},null,8,["item","assets"])]),_:1}),l(H,{value:"refs"},{default:s(()=>[l(o,{item:a.item},null,8,["item"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(m,{item:a.item},null,8,["item"]),(f(),E(se,{to:"body"},[l(I,{modelValue:t.vhistory,"onUpdate:modelValue":e[13]||(e[13]=r=>t.vhistory=r),current:{data:{lang:a.item.lang,type:a.item.type,name:a.item.name,data:a.item.data},files:a.item.files},load:()=>i.versions(a.item.id),onUse:e[14]||(e[14]=r=>i.use(r)),onRevert:e[15]||(e[15]=r=>{i.use(r),i.reset()})},null,8,["modelValue","current","load"])]))],64)}const B=k(Ee,[["render",ke],["__scopeId","data-v-3d412111"]]),Se={components:{ElementListItems:Z,ElementDetail:B,Navigation:G,AsideList:Y,User:J},inject:["openView"],data:()=>({aside:null,filter:{trashed:"WITHOUT",publish:null,editor:null,lang:null}}),setup(){const t=F(),e=R();return{auth:S(),drawer:e,languages:t}},methods:{languages(){const t=[{title:"All",icon:"mdi-playlist-check",value:{lang:null}}];for(const e in this.languages.available)t.push({title:this.languages.available[e],icon:"mdi-translate",value:{lang:e}});return t},open(t){this.openView(B,{item:t})}}};function Ie(t,e,a,n,u,i){var r;const p=g("User"),o=g("Navigation"),m=g("ElementListItems"),I=g("AsideList");return f(),c(D,null,[l(M,{elevation:0,density:"compact"},{prepend:s(()=>[l(v,{onClick:e[0]||(e[0]=y=>n.drawer.toggle("nav"))},{default:s(()=>[l(A,{size:"x-large"},{default:s(()=>[h(b(n.drawer.nav?"mdi-close":"mdi-menu"),1)]),_:1})]),_:1})]),append:s(()=>[l(p),l(v,{onClick:e[1]||(e[1]=y=>n.drawer.toggle("aside"))},{default:s(()=>[l(A,{size:"x-large"},{default:s(()=>[h(b(n.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1})]),default:s(()=>[l(z,null,{default:s(()=>e[4]||(e[4]=[h("Shared elements")])),_:1,__:[4]})]),_:1}),l(o),l(W,{class:"element-list"},{default:s(()=>[l(P,null,{default:s(()=>[l(T,{class:"box"},{default:s(()=>[l(m,{filter:t.filter,onSelect:e[2]||(e[2]=y=>i.open(y))},null,8,["filter"])]),_:1})]),_:1})]),_:1}),l(I,{filter:t.filter,"onUpdate:filter":e[3]||(e[3]=y=>t.filter=y),content:[{key:"publish",items:[{title:"All",icon:"mdi-playlist-check",value:{publish:null}},{title:"Published",icon:"mdi-publish",value:{publish:"PUBLISHED"}},{title:"Scheduled",icon:"mdi-clock-outline",value:{publish:"SCHEDULED"}},{title:"Drafts",icon:"mdi-pencil",value:{publish:"DRAFT"}}]},{key:"trashed",items:[{title:"All",icon:"mdi-playlist-check",value:{trashed:"WITH"}},{title:"Available only",icon:"mdi-delete-off",value:{trashed:"WITHOUT"}},{title:"Only trashed",icon:"mdi-delete",value:{trashed:"ONLY"}}]},{key:"editor",items:[{title:"All",icon:"mdi-playlist-check",value:{editor:null}},{title:"Edited by me",icon:"mdi-account",value:{editor:(r=this.auth.me)==null?void 0:r.email}}]},{key:"lang",items:i.languages()}]},null,8,["filter","content"])],64)}const Ce=k(Se,[["render",Ie],["__scopeId","data-v-6795a139"]]);export{Ce as default};
