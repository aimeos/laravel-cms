import{_ as w,c as d,a as h,b as v,w as F,r as y,T as _,F as b,H as U,Z as C,$ as L,o as r,d as c,a0 as j,g as I,Y as D,h as O,i as R,f as m}from"../index.js";import{l as x}from"./vue-draggable-plus-By0QSgvd.js";import{F as A,a as V}from"./FileDetail-DoAmmBBH.js";import{F as B}from"./FileDialog-BmY6pYYe.js";import"./HistoryDialog-DB5QzTyj.js";const E={components:{FileDetail:V,FileDialog:B,FileListItems:A,VueDraggable:x},inject:["openView"],props:{modelValue:{type:Array,default:()=>[]},config:{type:Object,default:()=>{}},assets:{type:Object,default:()=>{}},readonly:{type:Boolean,default:!1}},emits:["update:modelValue","error","addFile","removeFile"],setup(){const t=C();return{app:L(),auth:t}},data(){return{images:[],index:Math.floor(Math.random()*1e5),selected:null,vfiles:!1}},unmounted(){this.images.forEach(t=>{var e;(e=t.path)!=null&&e.startsWith("blob:")&&URL.revokeObjectURL(t.path)})},methods:{add(t){if(!this.auth.can("file:add")){this.messages.add("Permission denied","error");return}const e=[],i=t.target.files||t.dataTransfer.files||[];i.length&&(Array.from(i).forEach(n=>{const a=URL.createObjectURL(n),l=this.images.length;this.images[l]={path:a,uploading:!0};const p=this.$apollo.mutate({mutation:U`mutation($file: Upload!) {
              addFile(file: $file) {
                id
                mime
                name
                path
                previews
              }
            }`,variables:{file:n},context:{hasUpload:!0}}).then(o=>{var u;if(o.errors)throw o.errors;const s=((u=o.data)==null?void 0:u.addFile)||{};return s.previews=JSON.parse(s.previews)||{},delete s.__typename,new Promise((g,k)=>{const f=new Image;f.onload=g,f.onerror=k,f.src=this.url(Object.values(s.previews)[0])}).then(()=>{this.images[l]=s,this.$emit("addFile",s.id),URL.revokeObjectURL(a)})}).catch(o=>{this.$log("Images::addFile(): Error uploading images",t,o)});e.push(p)}),Promise.all(e).then(()=>{this.$emit("update:modelValue",this.images.map(n=>({id:n.id,type:"file"})))}),this.selected=null)},change(){this.$emit("update:modelValue",this.images.map(t=>({id:t.id,type:"file"})))},open(t){this.openView(V,{item:t})},remove(t){var e;(e=this.images[t])!=null&&e.id&&this.$emit("removeFile",this.images[t].id),this.images.splice(t,1),this.$emit("update:modelValue",this.images.map(i=>({id:i.id,type:"file"})))},select(t){this.images[this.images.length]=t,this.$emit("addFile",t.id),this.vfiles=!1},srcset(t){let e=[];for(const i in t)e.push(`${this.url(t[i])} ${i}w`);return e.join(", ")},url(t){return t.startsWith("http")||t.startsWith("blob:")?t:this.app.urlfile.replace(/\/+$/g,"")+"/"+t},async validate(){return await!0}},watch:{modelValue:{immediate:!0,handler(t){if(!this.images.length)for(const e of t||[])this.assets[e.id]&&this.images.push(this.assets[e.id])}}}},N=["onClick"],P=["onClick"],S={key:0,class:"file-input"},M={class:"upload-file"},T=["accept","id","value"],W=["for"];function q(t,e,i,n,a,l){const p=y("VueDraggable"),o=y("FileDialog");return r(),d(b,null,[h(p,{modelValue:a.images,"onUpdate:modelValue":e[2]||(e[2]=s=>a.images=s),disabled:i.readonly,onChange:e[3]||(e[3]=s=>l.change()),draggable:".image",group:"images",class:"files",animation:"500"},{default:F(()=>[(r(!0),d(b,null,j(a.images,(s,u)=>(r(),d("div",{key:u,class:"image",onClick:g=>l.open(s)},[s.uploading?(r(),v(I,{key:0,color:"primary",height:"5",indeterminate:"",rounded:""})):c("",!0),s.path?(r(),v(D,{key:1,srcset:l.srcset(s.previews),src:l.url(s.path),draggable:"false"},null,8,["srcset","src"])):c("",!0),!i.readonly&&s.id?(r(),d("button",{key:2,onClick:O(g=>l.remove(u),["stop"]),class:"btn-overlay",title:"Remove image",type:"button"},[h(R,{icon:"mdi-trash-can",role:"img"})],8,P)):c("",!0)],8,N))),128)),i.readonly?c("",!0):(r(),d("div",S,[n.auth.can("file:view")?(r(),d("div",{key:0,class:"select-file",onClick:e[0]||(e[0]=s=>a.vfiles=!0)},e[6]||(e[6]=[m("label",null,[m("span",{class:"btn"},"Select file")],-1)]))):c("",!0),m("div",M,[m("input",{type:"file",onInput:e[1]||(e[1]=s=>l.add(s)),accept:i.config.accept||"image/*",id:"images-"+a.index,value:a.selected,multiple:"",hidden:""},null,40,T),m("label",{for:"images-"+a.index},e[7]||(e[7]=[m("span",{class:"btn"},"Add files",-1)]),8,W)])]))]),_:1},8,["modelValue","disabled"]),(r(),v(_,{to:"body"},[h(o,{modelValue:a.vfiles,"onUpdate:modelValue":e[4]||(e[4]=s=>a.vfiles=s),onAdd:e[5]||(e[5]=s=>l.select(s)),filter:{mime:"image/"},grid:""},null,8,["modelValue"])]))],64)}const z=w(E,[["render",q],["__scopeId","data-v-15af6dc3"]]);export{z as default};
